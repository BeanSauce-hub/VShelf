<script>
/* ========= Matrix 背景（原样） ========= */
(()=> {
  const c = document.getElementById('c');
  const x = c.getContext('2d');
  const CH = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const FS = 16, COLOR = "rgba(0,255,102,0.3)";
  let dpr=1, cols=0, drops=[];
  function resize(){
    dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = innerWidth, h = innerHeight;
    c.width = Math.floor(w * dpr);
    c.height = Math.floor(h * dpr);
    x.setTransform(dpr,0,0,dpr,0,0);
    x.font = `${FS}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`;
    x.textBaseline = "top";
    cols = Math.floor(w / FS);
    drops = Array(cols).fill(0);
    x.fillStyle = "#000"; x.fillRect(0,0,w,h);
  }
  function draw(){
    x.fillStyle = "rgba(0,0,0,0.07)";
    x.fillRect(0,0,innerWidth,innerHeight);
    x.fillStyle = COLOR;
    for(let i=0;i<cols;i++){
      const ch = CH[(Math.random()*CH.length)|0];
      const xPos = i * FS, yPos = drops[i] * FS;
      x.fillText(ch, xPos, yPos);
      if (yPos > innerHeight && Math.random() > 0.975) drops[i]=0; else drops[i]++;
    }
    requestAnimationFrame(draw);
  }
  addEventListener('resize', resize);
  resize(); draw();
})();

/* ========= 徽章对齐（原样） ========= */
const statusbar = document.getElementById('statusbar');
function alignBadge(){
  const gate = document.getElementById('gate');
  const target = (getComputedStyle(gate).display !== 'none') ? gate : document.querySelector('.panel');
  const r = target.getBoundingClientRect();
  statusbar.style.left = (r.left + r.width / 2) + 'px';
  statusbar.style.transform = 'translateX(-50%)';
}
addEventListener('resize', alignBadge);
addEventListener('DOMContentLoaded', alignBadge);

/* ========= 登录（原样） ========= */
const h = "c4ea541037f800a6c3ee534e5e29f8b833eaf7a11e6d4281510026dea5abcb30";
const pwd = document.getElementById('pwd');
const go  = document.getElementById('go');
const err = document.getElementById('err');
const showBtn = document.getElementById('show');

async function sha256(msg){
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(msg));
  return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,"0")).join("");
}
async function enter(){
  err.textContent="";
  const v=(pwd.value||"").trim();
  if(!v){ err.textContent="请先输入密码"; return; }
  try{
    const hash = await sha256(v);
    if(hash !== h){ err.textContent="密码不正确"; pwd.focus(); pwd.select(); return; }
  }catch(e){ err.textContent = "当前环境不支持安全校验（WebCrypto）。请用 https/本地服务器打开。"; return; }

  // 登录成功
  document.getElementById('gate').style.display="none";
  const app  = document.getElementById('app');
  app.style.display="grid";
  document.body.style.overflow = "hidden";
  document.getElementById('modeText').textContent = 'Virtual Shelf';
  alignBadge();

  try{
    setStatus('正在加载…');
    await fetchAllFromServer(); render();
    setStatus(`已加载 ${CACHE.length} 条`);
  }catch(e){ setStatus('加载失败：'+e.message); }
}
showBtn.addEventListener('click', ()=>{
  const showing = pwd.type==="text";
  pwd.type = showing? "password":"text";
  showBtn.textContent = showing? "显示":"隐藏";
  showBtn.setAttribute('aria-pressed', String(!showing));
  pwd.focus();
});
go.addEventListener('click', ()=>enter());
pwd.addEventListener('keydown', e=>{ if(e.key==="Enter") enter(); });
addEventListener('DOMContentLoaded', ()=> pwd.focus());

/* ========= 云端存储（GetPantry） ========= */
const PANTRY_ID = '492a92b0-9b05-488c-9621-85ef5fd5de61';
const BASKET    = 'vshelf';
const API       = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET}`;

/* 重要：为了避免“越下架越多”的视觉错觉，建议设置为 true（同编号只保留时间最新的一条） */
const UNIQUE_BY_NUMBER = false;

const $ = s => document.querySelector(s);
const setStatus = t => { $('#status').textContent = t || '' };
const ids = s => (s.toUpperCase().match(/[A-Z0-9]+/g) || []);
const nowStr = () => { const d=new Date(), p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; };
const wait = ms => new Promise(r=>setTimeout(r,ms));

/* —— 全局串行队列，避免并发写/读竞态 —— */
let queue = Promise.resolve();
function enqueue(task){ queue = queue.then(task, task); return queue; }

let CACHE = [];

/* —— 去重：同编号只保留时间最新 —— */
function dedupeRows(rows){
  if (!UNIQUE_BY_NUMBER) return rows.slice();
  const newer = (a,b)=> String(a.时间) >= String(b.时间) ? a : b;
  const m = new Map();
  for (const r of rows){
    const k = String(r.编号).toUpperCase();
    m.set(k, m.has(k) ? newer(m.get(k), r) : r);
  }
  return [...m.values()];
}

/* —— 429 退避重试 + 反缓存头 —— */
async function fetchRetry(url, opts = {}, allow404 = false){
  let delay = 1200;
  for (let i = 0; i < 7; i++){
    const r = await fetch(url, {
      cache: 'no-store',
      headers: {
        'Accept': 'application/json',
        'Pragma': 'no-cache',
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        ...(opts.headers||{})
      },
      ...opts
    }).catch(()=>({ ok:false, status:0 }));
    if (r.status === 429){ setStatus(`频率过高，${Math.round(delay/1000)}s 后重试…`); await wait(delay); delay = Math.min(Math.round(delay * 1.8), 12000); continue; }
    if (allow404 && r.status === 404) return r;
    if (!r.ok){
      if (i === 6){ const txt = await (r.text?.() || ''); throw new Error(`HTTP ${r.status} ${txt}`); }
      await wait(delay); delay = Math.min(Math.round(delay * 1.8), 12000); continue;
    }
    return r;
  }
  throw new Error('网络重试耗尽');
}

/* —— 写频率节流（冷却） —— */
const WRITE_COOLDOWN_MS = 1800;
let lastWriteAt = 0;
async function ensureCooldown(){
  const now = Date.now();
  const waitMs = Math.max(0, WRITE_COOLDOWN_MS - (now - lastWriteAt));
  if (waitMs > 0) await wait(waitMs);
  lastWriteAt = Date.now();
}

/* —— 读（以远端为准，带 cache-bust） —— */
async function readRows(){
  const r = await fetchRetry(`${API}?ts=${Date.now()}`, {}, true);
  if (r.status === 404) return [];
  const j = await r.json().catch(()=>({ rows:[] }));
  return Array.isArray(j.rows) ? j.rows : [];
}

/* ========= 写入 + 回读核验（关键修复） =========
   把要保存的 rows 全量 PUT 到远端，然后回读检查是否完全一致；
   若不一致（CDN/并发导致），自动退避重试，确保“真正删除/真正覆盖”。 */
function normalizeRows(rows){
  // 稳定排序 + 大写编号，避免序列化差异导致误判
  const arr = rows.map(r=>({ 编号:String(r.编号||'').toUpperCase(), 时间:String(r.时间||'') }));
  arr.sort((a,b)=> (a.编号===b.编号) ? a.时间.localeCompare(b.时间) : a.编号.localeCompare(b.编号));
  return arr;
}
function rowsEqual(a,b){
  const A = JSON.stringify(normalizeRows(a));
  const B = JSON.stringify(normalizeRows(b));
  return A === B;
}

async function commitAndVerify(nextRows, maxRetry = 5){
  const payload = UNIQUE_BY_NUMBER ? dedupeRows(nextRows) : nextRows.slice();
  const body = JSON.stringify({ rows: payload });

  return enqueue(async ()=>{
    let attempt = 0, delay = 800;
    while (true){
      await ensureCooldown();
      // 尝试 PUT；若篮子不存在（404/405），改用 POST 创建
      let r = await fetchRetry(API, { method:'PUT', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body }, true);
      if (r.status === 404 || r.status === 405){
        await ensureCooldown();
        await fetchRetry(API, { method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' }, body });
      }
      // 回读核验
      await ensureCooldown();
      const remote = await readRows();
      const ok = rowsEqual(payload, remote);
      if (ok){
        CACHE = payload.slice();
        return true;
      }
      if (attempt++ >= maxRetry) throw new Error('写入后核验失败（可能有他端在同时写入），请稍后再试或更换篮子名。');
      setStatus(`远端尚未一致，重试第 ${attempt}/${maxRetry} 次…`);
      await wait(delay); delay = Math.min(delay*1.8, 6000);
    }
  });
}

/* —— 删除篮子（CleanAll 用） —— */
async function deleteBasket(){
  await ensureCooldown();
  await fetchRetry(API, { method:'DELETE' }, true); // 200/204/404 都视为成功
}

/* —— 以远端为准（并去重） —— */
async function fetchAllFromServer(){
  const remote = await enqueue(()=>readRows());
  CACHE = UNIQUE_BY_NUMBER ? dedupeRows(remote) : remote.slice();
}

/* ========= 搜索/筛选/排序（原样） ========= */
const state = { sortKey:'时间', sortDir:'desc', q:'', d1:null, d2:null };
const parseTime = s => { if(!s) return null; const d=new Date(s.replace(' ','T')); return isNaN(d)?null:d; };
const matchKeywords = (no,q)=>{ if(!q) return true; const tokens=q.toUpperCase().split(/[,\s]+/).filter(Boolean); const S=String(no||'').toUpperCase(); return tokens.every(tok=>S.includes(tok)); };
const inDateRange = (timeStr,d1,d2)=>{ if(!d1&&!d2) return true; const d=parseTime(timeStr); if(!d) return false; if(d1&&d<d1) return false; if(d2){ const e=new Date(d2.getFullYear(),d2.getMonth(),d2.getDate(),23,59,59,999); if(d>e) return false; } return true; };

function applyFilterSort(data){
  const filtered = data.filter(r => matchKeywords(r.编号, state.q) && inDateRange(r.时间, state.d1, state.d2));
  const key = state.sortKey, dir = state.sortDir==='asc'?1:-1;
  filtered.sort((a,b)=>{
    if(key==='时间'){
      const da=parseTime(a.时间), db=parseTime(b.时间);
      if(!da&&!db) return 0; if(!da) return 1; if(!db) return -1;
      return (da-db)*dir;
    }else{
      return String(a.编号||'').localeCompare(String(b.编号||''),'zh-Hans-CN')*dir;
    }
  });
  return filtered;
}
function render(){
  const rows = applyFilterSort(CACHE);
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';
  if(!rows.length){
    tb.innerHTML = `<tr><td class="empty" colspan="2">无匹配数据</td></tr>`;
    setStatus(state.q || state.d1 || state.d2 ? '已应用筛选' : '');
  }else{
    const frag = document.createDocumentFragment();
    for(const r of rows){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = r.编号 ?? '';
      const td2 = document.createElement('td'); td2.textContent = r.时间 ?? '';
      tr.append(td1, td2); frag.appendChild(tr);
    }
    tb.appendChild(frag);
    setStatus(`共 ${rows.length} 条${(rows.length !== CACHE.length) ? '（已筛选）' : ''}`);
  }
  document.querySelectorAll('th[data-key]').forEach(th=>{
    th.classList.toggle('active', th.dataset.key===state.sortKey);
    th.querySelector('.sort').textContent = (th.dataset.key===state.sortKey) ? (state.sortDir==='asc'?'▲':'▼') : '';
  });
}

/* ========= 输入框：回车不触发（原样） ========= */
const inp = document.getElementById('inp');
addEventListener('DOMContentLoaded', () => {
  if (inp) inp.focus();
  setInterval(() => { if (document.activeElement !== inp) inp.focus(); }, 2000);
});
inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });

/* ========= 工具条 & 排序（原样） ========= */
const qInput = document.getElementById('q'), d1Input = document.getElementById('d1'), d2Input = document.getElementById('d2'), clearBtn = document.getElementById('clear');
let qTimer = null;
qInput.addEventListener('input', ()=>{ clearTimeout(qTimer); qTimer = setTimeout(()=>{ state.q = qInput.value.trim(); render(); }, 200); });
d1Input.addEventListener('change', ()=>{ state.d1 = d1Input.value ? new Date(d1Input.value + 'T00:00:00') : null; render(); });
d2Input.addEventListener('change', ()=>{ state.d2 = d2Input.value ? new Date(d2Input.value + 'T00:00:00') : null; render(); });
clearBtn.addEventListener('click', ()=>{ qInput.value=''; d1Input.value=''; d2Input.value=''; state.q=''; state.d1=null; state.d2=null; render(); });
document.querySelectorAll('th[data-key]').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.dataset.key;
    if(state.sortKey === key){ state.sortDir = (state.sortDir === 'asc') ? 'desc' : 'asc'; }
    else{ state.sortKey = key; state.sortDir = (key === '时间') ? 'desc' : 'asc'; }
    render();
  });
});

/* ========= 上/下架（修复：写入后核验） ========= */
const btnAdd = document.getElementById('btnAdd');
const btnDel = document.getElementById('btnDel');

async function safeRun(btn, fn){
  try{ btn.disabled = true; await fn(); }
  catch(e){ console.error(e); setStatus('错误：' + (e?.message||e)); }
  finally{ btn.disabled = false; }
}

if (!window.__vShelfBound){
  window.__vShelfBound = true;

  // 上架（新增）
  btnAdd.addEventListener('click', ()=> safeRun(btnAdd, async ()=>{
    const raw = (inp.value||'').trim();
    if(!raw) return;

    // 硬清空（真正清到篮子级别）
    if (raw.toLowerCase() === 'cleanall'){
      if (!confirm('确定要清空所有记录吗？此操作不可撤销。')) return;
      setStatus('正在硬清空（DELETE 篮子）…');
      try{
        await enqueue(async ()=>{ await deleteBasket(); });
        CACHE = []; render();
        setStatus('表格已清空；如需避免他端写回旧数据，可临时更换 BASKET 名。');
      }catch(e){ console.error(e); setStatus('清空失败：'+(e?.message||e)); }
      inp.value='';
      return;
    }

    const arr = ids(raw);
    if(!arr.length){ setStatus('未识别到任何编号'); inp.focus(); return; }

    const t = nowStr();
    let draft = CACHE.map(r=>({...r}));
    for(const n of arr) draft.push({ 编号:String(n).toUpperCase(), 时间:t });
    draft = UNIQUE_BY_NUMBER ? dedupeRows(draft) : draft;

    await commitAndVerify(draft);
    inp.value=''; setStatus(`已新增 ${arr.length} 条，现有 ${CACHE.length} 条`);
    render(); inp.focus();
  }));

  // 下架（删除所填编号的全部记录）
  btnDel.addEventListener('click', ()=> safeRun(btnDel, async ()=>{
    const raw = (inp.value||'').trim();
    if(!raw) return;

    const arr = ids(raw);
    if(!arr.length){ setStatus('未识别到需要下架的编号'); inp.focus(); return; }

    const set = new Set(arr.map(x=>String(x).toUpperCase()));
    let draft = CACHE.filter(r => !set.has(String(r.编号).toUpperCase()));
    draft = UNIQUE_BY_NUMBER ? dedupeRows(draft) : draft;

    await commitAndVerify(draft);
    inp.value=''; setStatus(`已下架（共移除 ${arr.length} 个编号的记录），现有 ${CACHE.length} 条`);
    render(); inp.focus();
  }));
}
</script>
