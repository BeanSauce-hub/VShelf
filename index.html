<script>
/* ========== Matrix 背景（与你现有一致） ========== */
(()=>{const c=document.getElementById('c');const x=c.getContext('2d');const CH="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";const FS=16,COLOR="rgba(0,255,102,0.3)";let dpr=1,cols=0,drops=[];function resize(){dpr=Math.max(1,window.devicePixelRatio||1);const w=innerWidth,h=innerHeight;c.width=Math.floor(w*dpr);c.height=Math.floor(h*dpr);x.setTransform(dpr,0,0,dpr,0,0);x.font=`${FS}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`;x.textBaseline="top";cols=Math.floor(w/FS);drops=Array(cols).fill(0);x.fillStyle="#000";x.fillRect(0,0,w,h)}function draw(){x.fillStyle="rgba(0,0,0,0.07)";x.fillRect(0,0,innerWidth,innerHeight);x.fillStyle=COLOR;for(let i=0;i<cols;i++){const ch=CH[(Math.random()*CH.length)|0];const xPos=i*FS,yPos=drops[i]*FS;x.fillText(ch,xPos,yPos);if(yPos>innerHeight&&Math.random()>0.975)drops[i]=0;else drops[i]++}requestAnimationFrame(draw)}addEventListener('resize',resize);resize();draw()})();

/* ========== 顶部徽章对齐（与你现有一致） ========== */
const statusbar=document.getElementById('statusbar');
const gate=document.getElementById('gate');
function alignBadge(){const target=(getComputedStyle(gate).display!=='none')?gate:document.querySelector('.panel');const r=target.getBoundingClientRect();statusbar.style.left=(r.left+r.width/2)+'px';statusbar.style.transform='translateX(-50%)'}
addEventListener('resize',alignBadge);addEventListener('DOMContentLoaded',alignBadge);

/* ========== 登录（与你现有一致，去掉自动轮询 setInterval） ========== */
const h="c4ea541037f800a6c3ee534e5e29f8b833eaf7a11e6d4281510026dea5abcb30";
const pwd=document.getElementById('pwd');const go=document.getElementById('go');const err=document.getElementById('err');const showBtn=document.getElementById('show');
async function sha256(msg){const buf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(msg));return[...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,"0")).join("")}
async function enter(){
  err.textContent="";const v=(pwd.value||"").trim();if(!v){err.textContent="请先输入密码";return}
  try{const hash=await sha256(v);if(hash!==h){err.textContent="密码不正确";pwd.focus();pwd.select();return}}
  catch(e){err.textContent="当前环境不支持安全校验（WebCrypto）。请用 https/本地服务器打开。";return}
  // 展示应用
  gate.style.display="none";document.getElementById('app').style.display="grid";document.body.style.overflow="hidden";
  document.getElementById('modeText').textContent='Virtual Shelf';alignBadge();
  // 首次拉取
  try{setStatus('正在加载…');await fetchAllFromServer();render();setStatus(`已加载 ${CACHE.length} 条`)}catch(e){setStatus('加载失败：'+e.message)}
}
showBtn.addEventListener('click',()=>{const showing=pwd.type==="text";pwd.type=showing?"password":"text";showBtn.textContent=showing?"显示":"隐藏";showBtn.setAttribute('aria-pressed',String(!showing));pwd.focus()});
go.addEventListener('click',()=>enter());pwd.addEventListener('keydown',e=>{if(e.key==="Enter")enter()});addEventListener('DOMContentLoaded',()=>pwd.focus());

/* ========== 云端存储：GetPantry + 队列 + 429 退避 ========== */
const PANTRY_ID='492a92b0-9b05-488c-9621-85ef5fd5de61';
const BASKET='vshelf';
const API=`https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET}`;
const $=s=>document.querySelector(s);
const setStatus=t=>{$('#status').textContent=t||''};
const ids=s=>(s.toUpperCase().match(/[A-Z0-9]+/g)||[]);
const nowStr=()=>{const d=new Date(),p=n=>String(n).padStart(2,'0');return`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`};
const wait=ms=>new Promise(r=>setTimeout(r,ms));
const ALLOW_DUPLICATES=true;

// --- 请求串行队列，避免并发导致 429 ---
let queue=Promise.resolve();
function enqueue(task){queue=queue.then(task,task);return queue}

// --- 带 429 退避的 fetch ---
async function fetchRetry(url,opts={},allow404=false){
  let delay=800;
  for(let i=0;i<5;i++){
    const r=await fetch(url,opts).catch(e=>({ok:false,_e:e,status:0}));
    if(r.status===429){setStatus(`频率过高，${Math.round(delay/1000)}s 后自动重试…`);await wait(delay);delay=Math.min(delay*2,10000);continue}
    if(allow404 && r.status===404) return r;
    if(!r.ok){ if(i===4) { const txt=await (r.text?.()||Promise.resolve('')); throw new Error(`HTTP ${r.status} ${txt}`)} await wait(delay);delay=Math.min(delay*2,10000);continue }
    return r;
  }
  throw new Error('网络重试耗尽');
}

async function readRows(){
  const r=await fetchRetry(`${API}?ts=${Date.now()}`,{cache:'no-store',headers:{'Accept':'application/json'}},true);
  if(r.status===404) return [];
  const j=await r.json().catch(()=>({rows:[]}));
  return Array.isArray(j.rows)?j.rows:[];
}
async function writeRows(rows){
  const body=JSON.stringify({rows});
  let r=await fetchRetry(API,{method:'PUT',headers:{'Content-Type':'application/json','Accept':'application/json'},body});
  if(r.status===404||r.status===405){
    r=await fetchRetry(API,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body});
  }
}

// ====== 过滤 / 排序（与你现有一致） ======
const state={sortKey:'时间',sortDir:'desc',q:'',d1:null,d2:null};
const parseTime=s=>{if(!s)return null;const d=new Date(s.replace(' ','T'));return isNaN(d)?null:d};
const matchKeywords=(no,q)=>{if(!q)return true;const tokens=q.toUpperCase().split(/[,\s]+/).filter(Boolean);const S=String(no||'').toUpperCase();return tokens.every(tok=>S.includes(tok))};
const inDateRange=(timeStr,d1,d2)=>{if(!d1&&!d2)return true;const d=parseTime(timeStr);if(!d)return false;if(d1&&d<d1)return false;if(d2){const e=new Date(d2.getFullYear(),d2.getMonth(),d2.getDate(),23,59,59,999);if(d>e)return false}return true};

let CACHE=[];
function applyFilterSort(data){
  const filtered=data.filter(r=>matchKeywords(r.编号,state.q)&&inDateRange(r.时间,state.d1,state.d2));
  const key=state.sortKey,dir=state.sortDir==='asc'?1:-1;
  filtered.sort((a,b)=>{
    if(key==='时间'){
      const da=parseTime(a.时间),db=parseTime(b.时间);
      if(!da&&!db)return 0;if(!da)return 1;if(!db)return -1;
      return (da-db)*dir;
    }else{
      return String(a.编号||'').localeCompare(String(b.编号||''),'zh-Hans-CN')*dir;
    }
  });
  return filtered;
}
function render(){
  const rows=applyFilterSort(CACHE);
  const tb=document.getElementById('tbody');tb.innerHTML='';
  if(!rows.length){tb.innerHTML=`<tr><td class="empty" colspan="2">无匹配数据</td></tr>`;setStatus(state.q||state.d1||state.d2?'已应用筛选':'')}
  else{
    const frag=document.createDocumentFragment();
    for(const r of rows){const tr=document.createElement('tr');const td1=document.createElement('td');td1.textContent=r.编号??'';const td2=document.createElement('td');td2.textContent=r.时间??'';tr.append(td1,td2);frag.appendChild(tr)}
    tb.appendChild(frag);
    setStatus(`共 ${rows.length} 条${(rows.length!==CACHE.length)?'（已筛选）':''}`);
  }
  document.querySelectorAll('th[data-key]').forEach(th=>{
    th.classList.toggle('active',th.dataset.key===state.sortKey);
    th.querySelector('.sort').textContent=(th.dataset.key===state.sortKey)?(state.sortDir==='asc'?'▲':'▼'):'';
  });
}

async function fetchAllFromServer(){ CACHE = await enqueue(()=>readRows()); }
async function addToServer(arr){
  await enqueue(async ()=>{
    const rows=await readRows();
    const t=nowStr();
    if(ALLOW_DUPLICATES){for(const n of arr) rows.push({编号:String(n).toUpperCase(),时间:t})}
    else{const map=new Map(rows.map(r=>[String(r.编号).toUpperCase(),r]));for(const n of arr) map.set(String(n).toUpperCase(),{编号:String(n).toUpperCase(),时间:t});rows.splice(0,rows.length,...map.values())}
    await writeRows(rows); await wait(300);
  });
}
async function delFromServer(arr){
  await enqueue(async ()=>{
    const set=new Set(arr.map(x=>String(x).toUpperCase()));
    const rows=await readRows(); const kept=rows.filter(r=>!set.has(String(r.编号).toUpperCase()));
    await writeRows(kept); await wait(300);
  });
}

/* ====== 扫描枪友好 ====== */
const inp=document.getElementById('inp');let lastKeyTime=0;const SCAN_THRESHOLD=120;
addEventListener('DOMContentLoaded',()=>{if(inp)inp.focus();setInterval(()=>{if(document.activeElement!==inp)inp.focus()},2000)});
inp.addEventListener('keydown',e=>{if(e.key!=='Enter')lastKeyTime=Date.now()});

/* ====== 工具条 / 排序绑定 ====== */
const qInput=document.getElementById('q');const d1Input=document.getElementById('d1');const d2Input=document.getElementById('d2');const clearBtn=document.getElementById('clear');
let qTimer=null;
qInput.addEventListener('input',()=>{clearTimeout(qTimer);qTimer=setTimeout(()=>{state.q=qInput.value.trim();render()},200)});
d1Input.addEventListener('change',()=>{state.d1=d1Input.value?new Date(d1Input.value+'T00:00:00'):null;render()});
d2Input.addEventListener('change',()=>{state.d2=d2Input.value?new Date(d2Input.value+'T00:00:00'):null;render()});
clearBtn.addEventListener('click',()=>{qInput.value='';d1Input.value='';d2Input.value='';state.q='';state.d1=null;state.d2=null;render()});
document.querySelectorAll('th[data-key]').forEach(th=>{th.addEventListener('click',()=>{const key=th.dataset.key;if(state.sortKey===key){state.sortDir=(state.sortDir==='asc')?'desc':'asc'}else{state.sortKey=key;state.sortDir=(key==='时间')?'desc':'asc'}render()})});

/* ====== 上/下架（禁用按钮 + 统一错误提示 + cleanall 修复） ====== */
const btnAdd=document.getElementById('btnAdd');const btnDel=document.getElementById('btnDel');
async function safeRun(btn,fn){try{btn.disabled=true;await fn()}catch(e){console.error(e);setStatus('错误：'+(e?.message||e))}finally{btn.disabled=false}}
btnAdd.addEventListener('click',()=>safeRun(btnAdd,async ()=>{
  const raw=(inp.value||'').trim();if(!raw) return;
  if(raw.toLowerCase()==='cleanall'){setStatus('正在清空…');await writeRows([]);await wait(300);await fetchAllFromServer();render();inp.value='';setStatus('表格已清空');return}
  const arr=ids(raw);if(arr.length===0){setStatus('未识别到任何编号');inp.focus();return}
  setStatus('正在上架…');await addToServer(arr);await fetchAllFromServer();render();inp.value='';setStatus(`已新增 ${arr.length} 条，现有 ${CACHE.length} 条`);inp.focus();
}));
btnDel.addEventListener('click',()=>safeRun(btnDel,async ()=>{
  const raw=(inp.value||'').trim();if(!raw) return;
  const arr=ids(raw);if(arr.length===0){setStatus('未识别到需要下架的编号');inp.focus();return}
  setStatus('正在下架…');await delFromServer(arr);await fetchAllFromServer();render();inp.value='';setStatus(`已下架，现有 ${CACHE.length} 条`);inp.focus();
}));
</script>
