<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OPS虚拟库位</title>
  <style>
    :root{ --neo:#00ff66; --neo-dim:rgba(0,255,102,.22); --ink:#0a0a0a; --fg:#e7ffee; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:transparent;overflow:hidden;}
    body{ display:grid;place-items:center;position:relative;color:var(--fg);
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }

    #c{position:fixed;inset:0;z-index:0;display:block}

    .fx-grid::before,.fx-grid::after{ content:""; position:fixed; inset:0; pointer-events:none; z-index:0; }
    .fx-grid::before{
      background:
        linear-gradient(transparent 95%, rgba(0,0,0,.35) 100%) 0 0/100% 2px,
        linear-gradient(90deg, rgba(0,0,0,.35) 1px, transparent 1px) 0 0/2px 100%;
      mix-blend-mode:soft-light;
    }
    .fx-grid::after{ background:linear-gradient(to bottom, rgba(0,255,102,.06), transparent 60%);
      animation:scan 6s linear infinite; mix-blend-mode:overlay; }
    @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}

    .card,.panel{ position:relative; z-index:1; border-radius:18px;
      background:linear-gradient(180deg, rgba(12,18,16,.58), rgba(6,10,8,.58));
      backdrop-filter:blur(10px); border:1px solid var(--neo-dim);
      box-shadow:0 0 0 1px rgba(0,255,102,.08) inset, 0 12px 40px rgba(0,0,0,.55), 0 0 24px rgba(0,255,102,.06); }
    .card{width:min(92vw, 460px); padding:28px 24px 22px;}

    .brand{display:flex;align-items:center;gap:10px;margin-bottom:12px;letter-spacing:.12em;text-transform:uppercase;font-weight:700;color:var(--fg)}
    .dot{width:9px;height:9px;border-radius:50%;background:var(--neo);box-shadow:0 0 14px var(--neo)}
    h1,h2{margin:0} h1{font-size:18px;opacity:.9}
    h2{font-size:clamp(22px, 3.5vw, 28px); letter-spacing:.06em; text-align:center; margin-bottom:10px}

    label{display:block;font-size:12px;color:#b5ffcf;margin:14px 0 6px;letter-spacing:.06em}
    .row{display:flex;gap:8px}
    input[type="password"], input[type="text"]{
      flex:1; padding:12px 12px 12px 14px; border-radius:12px; outline:none; color:var(--fg);
      background:rgba(3,7,5,.55); border:1px solid rgba(0,255,102,.18);
      box-shadow:inset 0 0 0 1px rgba(0,255,102,.08);
      transition:border-color .2s, box-shadow .2s, background .2s;
    }
    input::placeholder{color:#8bd6a8}
    input:focus{border-color:var(--neo); box-shadow:0 0 0 3px rgba(0,255,102,.18), inset 0 0 0 1px rgba(0,255,102,.18); background:rgba(3,7,5,.7)}

    button{ padding:12px 14px;border:0;border-radius:12px;cursor:pointer;font-weight:800; letter-spacing:.06em;
      transition:transform .08s ease, box-shadow .2s ease, background .2s ease; white-space:nowrap; color:#000; }
    .btn-ghost{background:rgba(0,0,0,.35); color:#c7ffe0; border:1px solid rgba(0,255,102,.22)}
    .btn-ghost[aria-pressed="true"]{background:rgba(0,255,102,.12)}
    .btn-primary{ background:linear-gradient(180deg,#00ff66 0%, #00cc55 100%); border:1px solid #00ff66;
      box-shadow:0 0 15px rgba(0,255,102,.6), 0 0 30px rgba(0,255,102,.4); }
    .btn-danger{ background:linear-gradient(180deg,#ff6b6b,#ff3b3b); border:1px solid rgba(255,90,90,.9);
      color:#000; box-shadow:0 0 15px rgba(255,90,90,.35), 0 0 30px rgba(255,90,90,.2); }
    button:hover{filter:brightness(1.05)} button:active{transform:translateY(1px) scale(.99)}
    button:disabled{opacity:.5;cursor:not-allowed;box-shadow:none!important}

    .statusbar{ position:fixed; top:12px; display:flex; gap:10px; z-index:1; font-size:12px; color:#b5ffcf;
      background:rgba(0,0,0,.35); border:1px solid rgba(0,255,102,.18); padding:6px 10px; border-radius:999px; backdrop-filter:blur(6px)}
    .pill{display:flex;align-items:center;gap:6px}
    .led{width:6px;height:6px;border-radius:50%;background:var(--neo);box-shadow:0 0 10px var(--neo)}

    .app{ display:none; position:relative; z-index:1; width:100%; min-height:100svh; padding:24px; overflow:auto;
      place-items:center; justify-items:center; }
    @supports (height: 100dvh){ .app{ min-height:100dvh; } }

    .panel{ width:min(96vw,1100px); padding:22px 20px; margin:auto; }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }

    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; margin-bottom:6px }
    .toolbar input[type="text"], .toolbar input[type="date"]{
      padding:10px 12px; border-radius:10px; border:1px solid rgba(0,255,102,.18);
      background:rgba(3,7,5,.45); color:var(--fg); outline:none
    }

    .preview{ height:clamp(280px, 58vh, 72dvh); min-height:260px; background:rgba(255,255,255,.06);
      border:1px solid rgba(0,255,102,.18); border-radius:12px; overflow:auto; padding:10px }
    @supports (height: 1dvh){ .preview{ height:clamp(280px, 58dvh, 72dvh); } }

    table{width:100%; border-collapse:collapse; font-size:13px; color:#eafaea}
    thead th{position:sticky; top:0; background:rgba(0,0,0,.35); border-bottom:1px solid rgba(0,255,102,.18); text-align:center; padding:8px}
    tbody td{padding:8px; border-bottom:1px solid rgba(255,255,255,.06); white-space:nowrap; text-align:center; color:#e7ffee}
    .empty{color:#95c7ab; padding:18px 8px; text-align:center}

    .ops{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center }
    .ops input[type="text"]{min-width:260px; flex:1}
    .status{font-size:12px; color:#b5ffcf; text-align:center; min-height:16px}
    th .sort{opacity:.7; font-size:12px; margin-left:2px} th.active{color:#b5ffcf}

    @media (min-width: 1200px){ .preview{ height:clamp(320px, 60vh, 70dvh); } }
  </style>
</head>
<body class="fx-grid">

  <canvas id="c"></canvas>

  <div class="statusbar" id="statusbar">
    <span class="pill"><span class="led"></span> MIA OPS</span>
    <span class="pill">v0.29</span>
    <span class="pill"><span id="modeText">Secure Gate</span></span>
  </div>

  <!-- 登录 -->
  <div class="card" id="gate" role="dialog" aria-labelledby="title">
    <div class="brand"><span class="dot"></span><h1 id="title">OPS 虚拟货架</h1></div>
    <label for="pwd">ACCESS CODE</label>
    <div class="row">
      <input id="pwd" type="password" placeholder="请输入口令…" autocomplete="current-password" />
      <button id="show" class="btn-ghost" type="button" aria-pressed="false">显示</button>
      <button id="go" class="btn-primary" type="button">进入</button>
    </div>
    <div id="err" class="error" role="alert" style="color:#ff6b6b; font-size:12px; min-height:18px; margin-top:10px; text-shadow:0 0 10px rgba(255,0,0,.25)"></div>
  </div>

  <!-- 应用 -->
  <div class="app" id="app">
    <div class="panel">
      <div class="grid">
        <div class="toolbar">
          <input id="q" type="text" placeholder="搜索编号（空格/逗号分隔多关键字）" />
          <input id="d1" type="date" aria-label="开始日期">
          <span>至</span>
          <input id="d2" type="date" aria-label="结束日期">
          <button id="clear" class="btn-ghost" type="button">清空筛选</button>
        </div>

        <div class="preview">
          <table>
            <thead>
              <tr>
                <th data-key="编号"  style="width:42%; cursor:pointer">运单号 <span class="sort"></span></th>
                <th data-key="时间"  style="cursor:pointer">操作时间 <span class="sort"></span></th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td class="empty" colspan="2">暂无数据</td></tr>
            </tbody>
          </table>
        </div>

        <div class="ops">
          <input id="inp" type="text" placeholder="编号可用逗号/空格/换行分隔" spellcheck="false" autocapitalize="off" autocomplete="off" autofocus />
          <button id="btnAdd" class="btn-primary" type="button">上架</button>
          <button id="btnDel" class="btn-danger" type="button">下架</button>
        </div>
        <div class="status" id="status"></div>
      </div>
    </div>
  </div>

<script>
/* ========= 省略重复的 Matrix / 登录 / 存储 / 渲染代码 ========= */
/* （这里保持和我上一条回答一致，含 commitAndVerify 真删除实现） */

/* ========= 实时同步（新增） ========= */
function rowsSignature(rows){return JSON.stringify(normalizeRows(rows));}
let WATCH_MIN_MS=1500, WATCH_MAX_MS=10000, watchDelay=WATCH_MIN_MS, watchStop=false;
let suppressWatchUntil=0;
function suppressWatch(ms=2500){suppressWatchUntil=Date.now()+ms;}
document.addEventListener('visibilitychange',()=>{if(!document.hidden){watchDelay=WATCH_MIN_MS;enqueue(async()=>{try{const remote=await readRows();if(!rowsEqual(remote,CACHE)){CACHE=UNIQUE_BY_NUMBER?dedupeRows(remote):remote.slice();render();setStatus(`已与云端同步（前台刷新） · ${CACHE.length} 条`);}}catch{}});}});
window.addEventListener('focus',()=>{document.dispatchEvent(new Event('visibilitychange'));});
async function watchRemoteLoop(){let lastSig=rowsSignature(CACHE);while(!watchStop){try{if(Date.now()<suppressWatchUntil||document.hidden){await wait(Math.min(watchDelay*1.2,WATCH_MAX_MS));}else{const remote=await enqueue(()=>readRows());const sig=rowsSignature(remote);if(sig!==lastSig){CACHE=UNIQUE_BY_NUMBER?dedupeRows(remote):remote.slice();render();setStatus(`已同步他端更新 · ${CACHE.length} 条`);lastSig=sig;watchDelay=Math.max(WATCH_MIN_MS,Math.round(watchDelay*0.6));}else{watchDelay=Math.min(WATCH_MAX_MS,Math.round(watchDelay*1.25));}await wait(watchDelay);}}catch{watchDelay=Math.min(WATCH_MAX_MS,Math.round((watchDelay||WATCH_MIN_MS)*1.5));await wait(watchDelay);}}}
const _commitAndVerify=commitAndVerify;
commitAndVerify=async function(nextRows,maxRetry){suppressWatch();try{const ok=await _commitAndVerify(nextRows,maxRetry);watchDelay=WATCH_MIN_MS;return ok;}finally{suppressWatch(1200);}};
addEventListener('DOMContentLoaded',()=>{startLiveSync();});
function startLiveSync(){if(window.__vShelfLive)return;window.__vShelfLive=true;watchStop=false;watchDelay=WATCH_MIN_MS;watchRemoteLoop();}
function stopLiveSync(){watchStop=true;window.__vShelfLive=false;}
</script>
</body>
</html>
